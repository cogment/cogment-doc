---
sidebar_position: 5
---

# Launch

Launch is a utility command meant to facilitate locally launching and shutting down an entire Cogment project at once.

When launch is used, a set of processes will be launched to run in parallel, as described by a [YAML definition file](#definition-file). Once any of these processes terminates, all other ones will be terminated as well.

## Command line

`cogment launch [options] filename [args...]`

`filename`: Name (and path) of the YAML definition file describing the processes to launch.

`options`:

[-q], [--quiet]: Disable some of the output generated by the launcher. Process output is never disabled by this option. To increase the level, more "q" can be added, up to `-qqq` disabling all launcher generated output.

`args`: These are arguments that will be used in [variable substitution](#variable-substitution) in the definition file.

E.g.:

```bash
$ cogment launch -qq ./launch.yaml 1000 8
```

## definition file

The launch definition file is a [YAML](https://yaml.org) formatted file where the details of the parallel processes to run are defined.
The file consists of at least a `scripts` top level node, and may also contain a `global` top level node.

### Nodes

#### Scripts

The `scripts` node contains the details of the processes to run.
Each node under `scripts` represents a process to run.
The name of the node becomes the identity of the process and serves to identify the process output.

Each process will run the contents of the `commands` list in sequence (i.e. the next command will run when the previous terminates). Each command runs in an independent environment (e.g. environment variables set by one command will not be seen by the others).

E.g.:

```yaml
scripts:
    process_a:  # The name of this process is "process_a"
        commands:
            - ["retrieve_db.sh"]
            - ["python3", "env/main.py"]

    process_b:  # The name of this process is "process_b"
        commands:
            - ["cogment", "service", "orchestrator"]
```

The output will then look something like this:

```output
2023-06-30T22:24:08Z [TRACE ] [process_a:(1/2)] Launch [what:[retrieve_db.sh]]
2023-06-30T22:24:08Z [stdout] [process_a:(1/2)] Retrieving default database...
2023-06-30T22:24:08Z [stderr] [process_a:(1/2)] Record #2278 inconsistent
2023-06-30T22:24:08Z [stdout] [process_a:(1/2)] Database retrieved in /app/sb/
2023-06-30T22:24:08Z [TRACE ] [process_a:(1/2)] Script command completed
...
```

Where "TRACE" is trace level information from the launcher (it could also be "INFO" for more important information).
"stdout", and "stderr" are the output from the process.
"process_a" is the name given to the process in the definition file and "(1/2)" means that it is the first command out of two for that process.
The time is in RFC3339 format.

##### Environment Variables

You can set environment variables using the `environment` node of the process.
These will be part of the environment of all commands in the process.

E.g:

```yaml
scripts:
    orchestrator:
        environment:
            COGMENT_ORCHESTRATOR_ACTOR_PORT: 9000
            COGMENT_LIFECYCLE_PORT: 9000
        commands:
            - ["cogment", "services", "orchestrator"]
```

##### Working folder

By default, the current working folder is set to the folder containing the launch script. You can override that behavior with the `folder` node for each process.
<!-- The `dir` node is deprecated. -->

E.g.:

```yaml
scripts:
    actor_alpha:
        folder: ./actors/alpha
        commands:
            - ["python3", "main.py"]
```

##### Quiet

You can control the process output by setting this value to `True` or `False`.
By default this is `False` and thus standard process output (stdout and stderr) are also output by the launcher.
If set to `True`, standard process output is ignored and not output by the launcher.

E.g.:

```yaml
scripts:
    setup:
        quiet: True
        commands:
            - ["python3", "setup.py"]
```

#### Global

The `global` node contains values that have a global scope (i.e. they affect all scripts defined in the file).
Some of these values can be overridden by the individual scripts.

##### Environment Variables

You can set global environment variables using the `environment` node under the `global` node.
These variables will be part of the environment of all scripts, unless overridden locally in the script's own `environment` node.

E.g:

```yaml
global:
    environment:
        COGMENT_LOG_LEVEL: info
        COGMENT_DIRECTORY_ENDPOINT: grpc://server:9010
```

##### Working folder

By default, the current working folder is set to the folder containing the definition file.
This can be changed with the `folder` node under the `global` node.
It will affect all scripts, unless locally overridden by the script's own `folder` node.
Each level can also build on the previous one if the provided folder is a relative folder.

E.g.:

```yaml
global:
    folder: ./app  # app folder where the definition file resides
scripts:
    local:
        folder: ./inside  # This is './app/inside' from where the definition file resides
    somewhere:
        folder: /home/some  # This is an absolute path independent of previous folder settings
```

### Variable substitution

<!-- This is using the go 'text.template' facility with the environment variables as dictionary -->
You can substitute environment variables using `{{.ENV_VAR}}` anywhere in the `commands` or `environment` values.
Environment variables previously set in the definition file can also be substituted that way.

E.g.:

```yaml
scripts:
    say_hi:
        environment:
            TYPE: "How"
            QUESTION: "{{.TYPE}} are you?"
        commands:
            - ["echo", "Hello, {{.USER}}. {{.QUESTION}}"]  # result: "Hello, XXX. How are you?"
```

To print the literal double curly open brackets, surround them with backticks inside substitution brackets: ```{{`{{`}}```.

You can also substitute the arguments from the command line of launch (e.g. `cogment launch ./launch.yaml arg1 arg2 arg3`) using `{{.__1}}`, `{{.__2}}`, `{{.__3}}`, etc.
Note that the `{{.__1}}` to `{{.__9}}` are always defined, but will be empty if no corresponding argument was given on the command line.
Arguments 10 (`{{.__10}}`) and above will only be defined if they were provided on the command line.

Undefined values will be replaced with `<no value>`.

E.g.:

```yaml
scripts:
    args_out:
        environment:
            NAME: foo
        commands:
            - ["echo", "{{`{{`}} brackets }}"]  # "{{ brackets }}"
            - ["echo", "The first 3 CLI arguments are: {{.__1}} {{.__2}} {{.__3}}"]
```

### Example

```yaml
global:
    environment:
        RUN_NAME: "COGRUN-{{.HOSTNAME}}-{{.__1}}"
        COGMENT_LOG_LEVEL: info
        DIR_PORT: 9010
        COGMENT_DIRECTORY_ENDPOINT: "grpc://server:{{.DIR_PORT}}"
    folder: /app

scripts:
    directory:
        folder: ./cogment
        environment:
            COGMENT_DIRECTORY_PORT: "{{.DIR_PORT}}"
        commands:
            - ["cogment", "services", "directory"]
    orchestrator:
        folder: ./cogment
        environment:
            COGMENT_ORCHESTRATOR_ACTOR_PORT: 0
            COGMENT_LIFECYCLE_PORT: 0
        commands:
            - ["sleep", "1"]
            - ["cogment", "services", "orchestrator"]
    runner:
        folder: ./pycode
        commands:
            - ["sleep", "1"]
            - ["python3", "runner.py", "-u {{.USER}}", "-n {{.RUN_NAME}}", "{{.__2}}"]
```
